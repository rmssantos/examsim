<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Azure AI Exam</title>
  <link rel="stylesheet" href="style-new.css" />
  <link rel="stylesheet" href="multi-exam-styles.css" />
  <link rel="stylesheet" href="modern-enhancements.css" />
  <link rel="stylesheet" href="exam-enhancements.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Minimal shell that only shows the exam UI -->
    <div id="exam-screen" class="screen active">
      <div class="theme-controls">
        <button class="theme-toggle" title="Toggle theme">
          <i class="fas fa-moon theme-icon"></i>
        </button>
      </div>
      <div class="exam-header">
        <div class="exam-info-header">
          <span id="current-exam-badge" class="exam-badge">Exam</span>
          <button id="switch-exam" class="btn btn-outline-sm" onclick="closeExamTab()">
            <i class="fas fa-door-open"></i> Close
          </button>
        </div>
        <div class="exam-progress">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <span id="question-counter">&nbsp;</span>
        </div>
        <div class="exam-timer">
          <i class="fas fa-clock"></i>
          <span id="timer">45:00</span>
        </div>
      </div>

      <div class="question-container">
        <div id="question-number" class="question-number">Question</div>
        <div id="question-type-indicator" class="question-type-indicator" style="display:none;">
          <i class="fas fa-info-circle"></i>
          <span id="question-type-text"></span>
        </div>
        <div id="question-text" class="question-text"></div>
        <div id="question-images" class="question-images-container"></div>
        <div id="options-container" class="options-container"></div>
        <div class="question-controls">
          <button id="mark-review-btn" class="btn btn-outline">
            <i class="fas fa-flag"></i> Mark for Review
          </button>
          <button id="show-answer-btn" class="btn btn-info">
            <i class="fas fa-lightbulb"></i> Show Answer
          </button>
        </div>
        <div id="answer-feedback" class="answer-feedback" style="display: none;">
          <div class="feedback-header">
            <span class="feedback-status"></span>
            <button id="close-feedback" class="close-feedback">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="feedback-content">
            <div class="correct-answer"></div>
            <div class="explanation"></div>
            <div id="explanation-images" class="explanation-images-container"></div>
          </div>
        </div>
        <div class="navigation-buttons">
          <button id="prev-btn" class="btn btn-secondary" disabled>
            <i class="fas fa-arrow-left"></i> Previous
          </button>
          <button id="next-btn" class="btn btn-primary">
            Next <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <button id="finish-exam" class="btn btn-warning finish-btn" style="display: none;">
        <i class="fas fa-check"></i> Finish Exam
      </button>
    </div>

    <div id="results-screen" class="screen">
      <div class="theme-controls">
        <button class="theme-toggle" title="Toggle theme">
          <i class="fas fa-moon theme-icon"></i>
        </button>
      </div>
      <div class="results-container">
        <div class="results-shell">
          <div class="results-layout">
            <section class="results-summary-card" id="resultsSummaryCard">
              <div class="summary-top-row">
                <span id="result-status" class="result-status result-status-chip">PASSED</span>
                <span id="exam-name-result" class="exam-name-pill">Exam</span>
              </div>
              <div class="summary-visuals">
                <div class="score-ring" id="scoreRing" style="--score-deg: 0deg;">
                  <div class="score-ring-inner">
                    <span id="percentage-score" class="score-percentage">0%</span>
                    <span class="score-label">Final Score</span>
                  </div>
                </div>
                <div class="status-icon" id="result-status-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
              </div>
              <div class="summary-metrics">
                <div class="summary-metric">
                  <span class="metric-label">Correct</span>
                  <span id="correct-count" class="metric-value">0</span>
                </div>
                <div class="summary-metric">
                  <span class="metric-label">Incorrect</span>
                  <span id="incorrect-count" class="metric-value">0</span>
                </div>
                <div class="summary-metric">
                  <span class="metric-label">Time</span>
                  <span id="time-spent" class="metric-value">0min</span>
                </div>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-meta">
                <div>
                  <span class="meta-label">Questions answered</span>
                  <strong id="total-questions-result">0</strong>
                </div>
                <div>
                  <span class="meta-label">Passing threshold</span>
                  <strong id="pass-score-target">70%</strong>
                </div>
              </div>
            </section>

            <section class="results-insights-card">
              <div class="insights-header">
                <h3><i class="fas fa-chart-line"></i> Performance Insights</h3>
                <p>See how this session compares to the target score.</p>
              </div>
              <div class="insight-progress">
                <div class="insight-label-row">
                  <span>Accuracy</span>
                  <span id="accuracy-percentage" class="insight-value">0%</span>
                </div>
                <div class="insight-bar">
                  <div id="correct-progress" class="stat-progress insight-correct"></div>
                </div>
              </div>
              <div class="insight-progress">
                <div class="insight-label-row">
                  <span>Missed</span>
                  <span id="missed-percentage" class="insight-value">0%</span>
                </div>
                <div class="insight-bar">
                  <div id="incorrect-progress" class="stat-progress insight-incorrect"></div>
                </div>
              </div>
              <ul class="insights-list">
                <li>
                  <span>Score vs pass mark</span>
                  <strong id="score-vs-pass">0 / 0%</strong>
                </li>
                <li>
                  <span>Time spent</span>
                  <strong id="time-spent-secondary">0min</strong>
                </li>
              </ul>
              <div class="insight-hint">
                <i class="fas fa-info-circle"></i>
                <span>Use Retake Exam to immediately replay with updated question order.</span>
              </div>
            </section>
          </div>

          <section id="detailed-review" class="detailed-review"></section>

          <div class="results-actions-modern">
            <button id="restart-exam" class="action-btn restart-btn">
              <div class="btn-icon"><i class="fas fa-redo-alt"></i></div>
              <div class="btn-content"><span class="btn-title">Retake Exam</span></div>
            </button>
            <button id="back-to-home" class="action-btn home-btn" onclick="closeExamTab()">
              <div class="btn-icon"><i class="fas fa-home"></i></div>
              <div class="btn-content"><span class="btn-title">Back to Home</span></div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="image-loader.js"></script>
  <script src="exam-manager.js"></script>

  <!-- Use unified exam loader -->
  <script src="exam-loader.js"></script>

  <!-- Image Storage (IndexedDB) -->
  <script src="image-storage.js"></script>
  
  <script src="script-multi-exam.js"></script>
  <script>
    // Close exam tab or navigate to homepage
    function closeExamTab() {
      // Try to close the tab (works if opened via window.open)
      window.close();
      
      // If close() didn't work (tab still open), redirect after small delay
      setTimeout(() => {
        if (!window.closed) {
          window.location.href = 'index.html';
        }
      }, 100);
    }

    // Dynamic exam loading from user-content
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for exams to load via exam-loader.js
      if (window.examsLoadedPromise) {
        await window.examsLoadedPromise;
      }

      const params = new URLSearchParams(window.location.search);
      const examId = params.get('exam') || 'ai900';

      console.log(`üìö Loading exam: ${examId}`);

      // Set image loader to current exam
      if (window.imageLoader) {
        window.imageLoader.setCurrentExam(examId);
      }

      // Check if images are available in IndexedDB
      if (window.imageStorage) {
        try {
          const imageCount = await window.imageStorage.getExamImageCount(examId);
          if (imageCount > 0) {
            console.log(`‚úÖ ${imageCount} images available in IndexedDB for ${examId}`);
          } else {
            console.warn(`‚ö†Ô∏è No images found for exam "${examId}". Please re-import the ZIP file.`);
            const warningBanner = document.createElement('div');
            warningBanner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ff9800;color:white;padding:10px 20px;text-align:center;z-index:10000;font-weight:bold;';
            warningBanner.innerHTML = '‚ö†Ô∏è Images not loaded! Please go back to homepage and re-import the exam ZIP file.';
            document.body.appendChild(warningBanner);
          }
        } catch (e) {
          console.warn('Could not check image count:', e);
        }
      }

      // Check if exam exists in window.userExams (loaded by exam-loader.js)
      if (window.userExams && window.userExams[examId]) {
        const examData = window.userExams[examId];

        if (window.examSimulator) {
          window.examSimulator.currentExam = examId;

          // Generate metadata if not present
          let metadata = examData.metadata;
          if (!metadata || !metadata.name) {
            metadata = {
              name: examId.toUpperCase(),
              fullName: `Custom Exam: ${examId}`,
              duration: 60,
              questionCount: Math.min(examData.questions.length, 45),
              passScore: 70,
              modules: []
            };
          }

          // Load exam into simulator
          window.examSimulator.examData[examId] = {
            name: metadata.name,
            fullName: metadata.fullName,
            duration: metadata.duration,
            questionCount: metadata.questionCount,
            passScore: metadata.passScore,
            questions: examData.questions,
            modules: metadata.modules || []
          };

          console.log(`‚úÖ Loaded ${examData.questions.length} questions for ${examId}`);
          window.examSimulator.startExam();
        }
      } else {
        console.error(`‚ùå Failed to load exam: ${examId}`);
        alert(`Exam ${examId} not found. Please import it first or check if it's activated.`);
      }
    });
  </script>
</body>
</html>
